<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FP Project2 Tester</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body,
      input,
      textarea {
        background-color: #202124;
        color: #e8eaed;
      }
      html,
      body {
        font-family: "Roboto", sans-serif;
      }
      a {
        color: #00aef8;
      }
      .content {
        display: flex;
        flex-wrap: wrap;
      }
      .content > div {
        margin-right: 16px;
      }
      button {
        background-color: #00aef8;
        color: rgba(0, 0, 0, 0.87);
        border: none;
        cursor: pointer;
        box-shadow: 0px 3px 1px -2px rgba(0, 0, 0, 0.2),
          0px 2px 2px 0px rgba(0, 0, 0, 0.14),
          0px 1px 5px 0px rgba(0, 0, 0, 0.12);
        padding: 6px 16px;
        font-family: "Roboto", sans-serif;
        border-radius: 4px;
        text-transform: uppercase;
      }
      .warning {
        color: rgb(255, 213, 153);
        background-color: rgb(25, 15, 0);
        padding: 6px 16px;
        border-radius: 4px;
        width: fit-content;
      }
      th,
      td {
        padding: 5px;
        text-align: left;
        border-bottom: 1px solid #444;
      }
    </style>
  </head>
  <body>
    <p>
      This is an open source project. Please
      <a href="https://github.com/diogotcorreia/proj2-fp-tester"
        >contribute with tests</a
      >.
    </p>
    <p>We currently have tests for some TADs. Full test list below.</p>
    <div class="warning">
      Due to the nature of the project, it's impossible to test all functions
      independently.<br />
      Some test failures might not be related to the function that's being
      tested, but to another function used in the test.
    </div>
    <div class="content">
      <div>
        <div>
          <p>Paste your file contents below:</p>
          <textarea id="code" rows="30" cols="80"></textarea>
        </div>
        <button id="submit">Run tests</button>

        <p>
          Last ran: <span id="last-run"><i>never</i></span>
          <br />
          <span id="ascii-alert" style="color: #f00"></span>
        </p>
      </div>
      <div>
        <p>Output:</p>
        <textarea
          id="result"
          readonly="readonly"
          rows="30"
          cols="80"
        ></textarea>
      </div>
    </div>
    <br />
    <p>
      Pro tip: If can't figure out what's wrong, you can check the
      <a
        href="https://github.com/diogotcorreia/proj2-fp-tester/blob/master/tests/test.py"
        target="_blank"
        >code for the tests on GitHub</a
      >.
    </p>
    <div id="advanced-error-div" style="display: none">
      <h2>Advanced Error Analysis</h2>
      <p>
        The following tests have failed. Click on each one to see the
        corresponding source code.
      </p>
      <ul id="advanced-error-content"></ul>
    </div>
    <div>
      <h2>Full Tests List</h2>
      <p>
        Below is a list of the functions that are being tested, along with how
        many tests each function has and which functions that test also depends
        on.
      </p>
      <h4>TAD Posição</h4>
      <table>
        <tr>
          <th>Function Name</th>
          <th>Test Count</th>
          <th>Observations</th>
        </tr>
        <tr>
          <td><code>cria_posicao</code> (tests for failure)</td>
          <td>8</td>
          <td></td>
        </tr>
        <tr>
          <td><code>cria_posicao</code> (tests for success)</td>
          <td>9</td>
          <td>Tests all 9 positions</td>
        </tr>
        <tr>
          <td><code>cria_copia_posicao</code></td>
          <td>9</td>
          <td></td>
        </tr>
        <tr>
          <td><code>obter_pos_c</code></td>
          <td>9</td>
          <td></td>
        </tr>
        <tr>
          <td><code>obter_pos_l</code></td>
          <td>9</td>
          <td></td>
        </tr>
        <tr>
          <td><code>posicoes_iguais</code> (tests for True)</td>
          <td>9</td>
          <td></td>
        </tr>
        <tr>
          <td><code>posicoes_iguais</code> (tests for False)</td>
          <td>1</td>
          <td></td>
        </tr>
        <tr>
          <td><code>eh_posicao</code> (tests for True)</td>
          <td>9</td>
          <td></td>
        </tr>
        <tr>
          <td><code>eh_posicao</code> (tests for False)</td>
          <td>10</td>
          <td></td>
        </tr>
        <tr>
          <td><code>posicao_para_str</code></td>
          <td>9</td>
          <td></td>
        </tr>
        <tr>
          <td><code>obter_posicoes_adjacentes</code></td>
          <td>9</td>
          <td></td>
        </tr>
        <tr>
          <td>
            Abstração procedimental (<code>obter_posicoes_adjacentes</code>)
          </td>
          <td>9</td>
          <td></td>
        </tr>
      </table>
      <h4>TAD Peça</h4>
      <table>
        <tr>
          <th>Function Name</th>
          <th>Test Count</th>
          <th>Observations</th>
        </tr>
        <tr>
          <td><code>cria_peca</code> (tests for failure)</td>
          <td>14</td>
          <td></td>
        </tr>
        <tr>
          <td><code>cria_peca</code> (tests for success)</td>
          <td>3</td>
          <td>Tests all 3 pieces</td>
        </tr>
        <tr>
          <td><code>cria_copia_peca</code></td>
          <td>3</td>
          <td></td>
        </tr>
        <tr>
          <td><code>pecas_iguais</code> (tests for True)</td>
          <td>3</td>
          <td></td>
        </tr>
        <tr>
          <td><code>pecas_iguais</code> (tests for False)</td>
          <td>12</td>
          <td></td>
        </tr>
        <tr>
          <td><code>eh_peca</code> (tests for True)</td>
          <td>3</td>
          <td></td>
        </tr>
        <tr>
          <td><code>eh_peca</code> (tests for False)</td>
          <td>3</td>
          <td>11</td>
        </tr>
        <tr>
          <td><code>peca_para_str</code></td>
          <td>3</td>
          <td></td>
        </tr>
        <tr>
          <td><code>peca_para_inteiro</code></td>
          <td>3</td>
          <td></td>
        </tr>
        <tr>
          <td>Abstração procedimental (<code>peca_para_inteiro</code>)</td>
          <td>3</td>
          <td></td>
        </tr>
      </table>
      <h4>TAD Tabuleiro</h4>
      <table>
        <tr>
          <th>Function Name</th>
          <th>Test Count</th>
          <th>Observations</th>
        </tr>
        <tr>
          <td><code>cria_tabuleiro</code></td>
          <td>1</td>
          <td>Only tests if it doesn't throw errors</td>
        </tr>
        <tr>
          <td><code>cria_copia_tabuleiro</code></td>
          <td>3</td>
          <td>Requires <code>tuplo_para_tabuleiro</code> to be working</td>
        </tr>
        <tr>
          <td><code>obter_peca</code></td>
          <td>3 * 9 = 27</td>
          <td>
            Requires <code>tuplo_para_tabuleiro</code>,
            <code>cria_posicao</code> and <code>peca_para_inteiro</code>
            to be working
          </td>
        </tr>
        <tr>
          <td><code>eh_tabuleiro</code> (tests for True)</td>
          <td>3</td>
          <td>Requires <code>tuplo_para_tabuleiro</code> to be working</td>
        </tr>
        <tr>
          <td><code>eh_tabuleiro</code> (tests for False)</td>
          <td>5 + 6 = 11</td>
          <td>Requires <code>tuplo_para_tabuleiro</code> to be working</td>
        </tr>
        <tr>
          <td><code>tabuleiros_iguais</code> (tests for True)</td>
          <td>3</td>
          <td>Requires <code>tuplo_para_tabuleiro</code> to be working</td>
        </tr>
        <tr>
          <td><code>tabuleiros_iguais</code> (tests for False)</td>
          <td>2 + 5 = 7</td>
          <td>Requires <code>tuplo_para_tabuleiro</code> to be working</td>
        </tr>
      </table>
      <p>There are some other tests that aren't in this list yet.</p>
    </div>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
      const TEST_FILE_LINK =
        "https://github.com/diogotcorreia/proj2-fp-tester/blob/master/tests/test.py";
      const ERROR_REGEX = /File ".+\/tests\/test.py", line (\d+), in (\w+)/g;
      const handleAdvancedErrorHandling = (output) => {
        const advancedDiv = document.getElementById("advanced-error-div");
        const matches = [...output.matchAll(ERROR_REGEX)];
        if (matches.length == 0) {
          advancedDiv.style.display = "none";
          return;
        }
        advancedDiv.style.display = "block";
        const content = document.getElementById("advanced-error-content");
        content.innerHTML = matches
          .map(
            ([, line, testName]) =>
              `<li><a href="${TEST_FILE_LINK}#L${line}" target="_blank">${testName}</a></li>`
          )
          .join("");
      };

      document.getElementById("submit").onclick = async () => {
        const content = document.getElementById("code").value;
        const button = document.getElementById("submit");
        button.disabled = true;
        const response = await axios.post("/run", content, {
          headers: { "Content-Type": "text/plain" },
        });
        button.disabled = false;
        const result = document.getElementById("result");
        result.value = response.data;
        const lastrun = document.getElementById("last-run");
        lastrun.innerText = new Date().toLocaleString();

        const nonAsciiCharacters = new Set(
          [...content].filter((c) => c.charCodeAt(0) > 128)
        );
        const msg =
          nonAsciiCharacters.size === 0
            ? ""
            : `You're using non-ASCII characters in your code: ${[
                ...nonAsciiCharacters,
              ].join(" ")}`;
        document.getElementById("ascii-alert").innerText = msg;

        handleAdvancedErrorHandling(response.data);
      };
    </script>
  </body>
</html>
